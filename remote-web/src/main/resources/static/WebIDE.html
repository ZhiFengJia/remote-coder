<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css"
          integrity="sha384-zCbKRCUGaJDkqS1kPbPd7TveP5iyJE0EjAuZQTgFLD2ylzuqKfdKlfG/eSrtxUkn" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/themes/default/style.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.64.0/theme/darcula.min.css"
          integrity="sha512-kqCOYFDdyQF4JM8RddA6rMBi9oaLdR0aEACdB95Xl1EgaBhaXMIe8T4uxmPitfq4qRmHqo+nBU2d1l+M4zUx1g=="
          crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.64.0/codemirror.min.css"
          integrity="sha512-CCnciBUnVXwa6IQT9q8EmGcarNit9GdKI5nJnj56B1iu0LuD13Qn/GZ+IUkrZROZaBdutN718NK6mIXdUjZGqg=="
          crossorigin="anonymous" referrerpolicy="no-referrer"/>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"
            integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
            integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js"
            integrity="sha384-VHvPCCyXqtD5DqJeNxl2dtTyhF78xXNXdkwX1CZeRusQfRKp+tA7hAShOK/B/fQ2"
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/jstree.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.64.0/codemirror.min.js"
            integrity="sha512-4DlmQ+aBOfYTZ3uzRKCDXdyL7y8IlopnVChhXG0pRFgyvhwONVQW3JX8e5DYoXUNr3evQpLZz7S3O1XxMH4WKA=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.64.0/mode/clike/clike.min.js"
            integrity="sha512-GAled7oA9WlRkBaUQlUEgxm37hf43V2KEMaEiWlvBO/ueP2BLvBLKN5tIJu4VZOTwo6Z4XvrojYngoN9dJw2ug=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <link rel="stylesheet" href="/css/darkly.css" />

    <title>Web IDE</title>
</head>

<body class="container-fluid">
<div class="row">
    <div class="col">
        <ul class="nav nav-pills" style="border: 1px solid #000000;">
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button"
                   aria-expanded="false">File</a>
                <div class="dropdown-menu">
                    <a class="dropdown-item" href="#">Create File or folder</a>
                    <a class="dropdown-item" href="#">Delete File or folder</a>
                    <a class="dropdown-item" href="#">Rename File or folder</a>
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item" href="#">开发中...</a>
                </div>
            </li>
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button"
                   aria-expanded="false">Git</a>
                <div class="dropdown-menu">
                    <a class="dropdown-item" href="#">Clone Project From GitHub</a>
                    <a class="dropdown-item" href="#">Commit</a>
                    <a class="dropdown-item" href="#">Pull</a>
                    <a class="dropdown-item" href="#">Push</a>
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item" href="#">开发中...</a>
                </div>
            </li>
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button"
                   aria-expanded="false">Help</a>
                <div class="dropdown-menu">
                    <a class="dropdown-item" href="#" data-toggle="modal" data-target="#aboutModal">About</a>
                    <a class="dropdown-item" href="https://github.com/ZhiFengJia/remote-coder" target="_blank">
                        Go to GitHub Home
                    </a>
                </div>
            </li>
            <li class="nav-item">
                <a id="execute" class="nav-link" role="button">
                    Run
                    <span id="loading" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"
                          style="display: none"></span></a>
            </li>
        </ul>
    </div>
</div>
<div class="row">
    <div class="col-2" style="padding-right:0px;padding-left:0px;">
        <div class="card" style="border:0em;">
            <div class="card-header" style="padding-left:0.5rem;padding-top: 0px;width: 50rem;">
                <ul class="nav nav-tabs card-header-tabs">
                    <li class="nav-item">
                        <a class="nav-link active" href="#">Project</a>
                    </li>
                </ul>
            </div>
            <div class="card-body overflow-auto">
                <div id="jstree"></div>
            </div>
        </div>
    </div>
    <div class="col-10" style="padding-right:0px;padding-left:0px;">
        <div class="card">
            <div class="card-header" style="padding-left:0.5rem;padding-top: 0px;">
                <ul class="nav nav-tabs card-header-tabs">
                    <li class="nav-item">
                        <a id="fileName" class="nav-link active" href="#">HelloWorld.java</a>
                    </li>
                </ul>
            </div>
            <div class="card-body" style="padding-right:0px;padding-left:0px;padding:0px;">
                <div class="editor_control">
                        <textarea class="form-control" id="code" name="code" style="display: none;">
/**
 * 简单示例
 *
 * @author jiazhifeng
 * @date 2021/12/07 10:14
 */
public class HelloWorld {
    public static void main(String[] args) {
        System.out.println("HelloWorld");
    }
}
                    </textarea>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col" style="padding-right:0px;padding-left:0px;">
        <nav>
            <div class="nav nav-tabs" id="nav-tab" role="tablist">
                <a class="nav-link active" id="nav-console-tab" data-toggle="tab" href="#nav-console" role="tab"
                   aria-controls="nav-console" aria-selected="true">Console</a>
                <a class="nav-link" id="nav-terminal-tab" data-toggle="tab" href="#nav-terminal" role="tab"
                   aria-controls="nav-terminal" aria-selected="false">Terminal</a>
            </div>
        </nav>
        <div class="tab-content" id="nav-tabContent">
            <div class="tab-pane fade show active" id="nav-console" role="tabpanel"
                 aria-labelledby="nav-console-tab">
                    <textarea id="console" class="form-control" placeholder="控制台"
                              readonly></textarea>
            </div>
            <div class="tab-pane fade" id="nav-terminal" role="tabpanel" aria-labelledby="nav-terminal-tab">
                开发中...
            </div>
        </div>
    </div>
</div>

<div id="className" hidden>HelloWorld</div>

<!-- Modal -->
<div class="modal fade" id="aboutModal" tabindex="-1" aria-labelledby="aboutModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="aboutModalLabel">项目简介</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                项目的目标是建立一种基于云的集成开发环境 (IDE)，您只需要一个浏览器，即可编写、运行和调试代码。
                它包括一个代码编辑器、调试程序和终端。您无需安装文件或配置开发计算机，即可开始新的项目。
                项目基于云，因此您可以从办公室、家中或任何地方使用已连接互联网的计算机完成项目。
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
        $(function () {
            var settings = {
                "url": "/project/tree",
                "method": "GET",
                "timeout": 0,
                "processData": false,
                "mimeType": "multipart/form-data",
                "dataType": "json",
                "contentType": false,
                "data": null
            };
            $.ajax(settings).done(function (response) {
                console.log(response);
                $('#jstree').jstree({
                    "plugins": ["wholerow"],
                    "core": {
                        'data': response
                    }
                });
            });

            $('#jstree').on("changed.jstree", function (e, data) {
                console.log(data);

                if (data.selected[0].charAt(data.selected[0].length - 1) != '/') {
                    getFileByPath(data.selected[0]);
                    var fileName = data.selected[0].substring(data.selected[0].lastIndexOf("/") + 1);
                    $("#fileName").text(fileName);
                }
            });
        });

        var editor = CodeMirror.fromTextArea(document.getElementById("code"), {
            mode: "text/x-java",
            lineNumbers: true,
            matchBrackets: true,
            indentUnit: 4,
            indentWithTabs: true,
        });
        editor.setSize('auto', '600');
        editor.setOption("theme", 'darcula');

        function getFileByPath(filePath) {
            console.log("当前选择的节点:" + filePath);
            var form = new FormData();
            form.append("filePath", filePath);
            var settings = {
                "url": "/project/getFile",
                "method": "POST",
                "timeout": 0,
                "processData": false,
                "mimeType": "multipart/form-data",
                "contentType": false,
                "data": form
            };
            $.ajax(settings).done(function (response) {
                if (response.valueOf() == "") {
                    console.log("当前选择的节点是文件夹");
                    return;
                }
                editor.setValue(response);

                var packageStr = editor.getLine(0);
                var className = filePath.substring(filePath.lastIndexOf("/") + 1, filePath.lastIndexOf("."));
                if (/^package.*$/.test(packageStr)) {
                    className = packageStr.substring(8, packageStr.indexOf(";")) + "/" + className;
                    className = className.replace(/\./g, "/");
                }
                console.log("className:" + className);
                $('#className').text(className);
            });
        }

        $('#execute').click(function () {
            $('#execute').attr("disabled", true);
            $('#loading').show();
            var form = new FormData();
            form.append("className", $('#className').text());
            form.append("sourceCode", editor.getValue());

            var settings = {
                "url": "/remote/executeJavaSourceCode",
                "method": "POST",
                "timeout": 0,
                "processData": false,
                "mimeType": "multipart/form-data",
                "contentType": false,
                "data": form
            };
            $.ajax(settings).done(function (response) {
                $("#console").val(response);
                $('#execute').attr("disabled", false);
                $('#loading').hide();
            });
        });

</script>
</body>

</html>