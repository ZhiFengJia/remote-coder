<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <!-- 必须的 meta 标签 -->
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!--    <link rel="stylesheet" href="/bootstrap-5.1.3/css/bootstrap.min.css"/>-->
    <!--    <link rel="stylesheet" href="/jstree3.3.12/themes/default/style.min.css"/>-->
    <!--    <link rel="stylesheet" href="/codemirror-5.64.0/lib/codemirror.css"/>-->

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/themes/default/style.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.64.0/codemirror.min.css"
          integrity="sha512-CCnciBUnVXwa6IQT9q8EmGcarNit9GdKI5nJnj56B1iu0LuD13Qn/GZ+IUkrZROZaBdutN718NK6mIXdUjZGqg=="
          crossorigin="anonymous" referrerpolicy="no-referrer"/>

    <!--    <script src="/jquery-3.6.0/jquery-3.6.0.min.js"></script>-->
    <!--    <script src="/bootstrap-5.1.3/js/bootstrap.bundle.min.js"></script>-->
    <!--    <script src="/jstree3.3.12/jstree.min.js"></script>-->
    <!--    <script src="/codemirror-5.64.0/lib/codemirror.js"></script>-->
    <!--Java代码高亮-->
    <!--    <script src="/codemirror-5.64.0/mode/clike/clike.js"></script>-->

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"
            integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/jstree.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.64.0/codemirror.min.js"
            integrity="sha512-4DlmQ+aBOfYTZ3uzRKCDXdyL7y8IlopnVChhXG0pRFgyvhwONVQW3JX8e5DYoXUNr3evQpLZz7S3O1XxMH4WKA=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.64.0/mode/clike/clike.min.js"
            integrity="sha512-GAled7oA9WlRkBaUQlUEgxm37hf43V2KEMaEiWlvBO/ueP2BLvBLKN5tIJu4VZOTwo6Z4XvrojYngoN9dJw2ug=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <title>Web IDE</title>
</head>

<body class="container-fluid">
<div class="row border">
    <div class="col">
        <ul class="nav nav-pills">
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle text-dark" data-toggle="dropdown" href="#" role="button"
                   aria-expanded="false">File</a>
                <div class="dropdown-menu">
                    <a class="dropdown-item" href="#">Create File</a>
                    <a class="dropdown-item" href="#">Delete File</a>
                    <a class="dropdown-item" href="#">Rename File</a>
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item" href="#">Create folder</a>
                </div>
            </li>
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle text-dark" data-toggle="dropdown" href="#" role="button"
                   aria-expanded="false">Git</a>
                <div class="dropdown-menu">
                    <a class="dropdown-item" href="#">Commit</a>
                    <a class="dropdown-item" href="#">Pull</a>
                    <a class="dropdown-item" href="#">Push</a>
                </div>
            </li>
            <li class="nav-item">
                <a id="execute" class="nav-link text-dark" role="button">
                    Run
                    <span id="loading" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"
                          style="display: none"></span></a>
            </li>
        </ul>
    </div>
</div>
<div class="row">
    <div class="col-2 border" style="padding-right:0px;padding-left:0px;">
        <div id="jstree"></div>
    </div>
    <div class="col-10 border" style="padding-right:0px;padding-left:0px;">
        <div class="editor_control">
            <textarea class="form-control" id="code" name="code" style="display: none;" rows="30">
/**
 * 简单示例
 *
 * @author jiazhifeng
 * @date 2021/12/07 10:14
 */
public class HelloWorld {
    public static void main(String[] args) {
        System.out.println("HelloWorld");
    }
}
            </textarea>
        </div>
    </div>
</div>
<div class="row border">
    <div class="col" style="padding-right:0px;padding-left:0px;">
        <div class="form-group">
            <textarea name="executeResult" class="form-control" id="exampleFormControlTextarea1" rows="10"
                      placeholder="控制台" readonly></textarea>
        </div>
    </div>
</div>

<div id="SourceCodeFileName" hidden>HelloWorld.java</div>

<script>
$(function () {
    var settings = {
            "url": "/project/tree",
            "method": "GET",
            "timeout": 0,
            "processData": false,
            "mimeType": "multipart/form-data",
            "dataType": "json",
            "contentType": false,
            "data": null
    };
    $.ajax(settings).done(function (response) {
        console.log(response);
        $('#jstree').jstree({
            "plugins" : [ "wholerow" ],
            "core" : {
                'data' : response
            }
        });
    });

    $('#jstree').on("changed.jstree", function (e, data) {
        console.log(data);
        getFileByPath(data.selected);
    });
});

var editor = CodeMirror.fromTextArea(document.getElementById("code"), {
    mode: "text/x-java",
    lineNumbers: true,
    matchBrackets: true,
    indentUnit: 4,
    indentWithTabs: true,
});
editor.setSize('auto', '620');

function getFileByPath(filePath) {
    console.log("当前选择的节点:" + filePath);
    var form = new FormData();
    form.append("filePath", filePath[0]);
    var settings = {
        "url": "/project/getFile",
        "method": "POST",
        "timeout": 0,
        "processData": false,
        "mimeType": "multipart/form-data",
        "contentType": false,
        "data": form
    };
    $.ajax(settings).done(function (response) {
        if(response.valueOf() == ""){
            console.log("当前选择的节点是文件夹");
            return;
        }
        editor.setValue(response);

        var packageStr = editor.getLine(0);
        //TODO linux和windows的分隔符不一致
        var className = filePath[0].substring(filePath[0].lastIndexOf("\\") + 1,filePath[0].lastIndexOf("."));
        if(/^package.*$/.test(packageStr)){
            className = packageStr.substring(8,packageStr.indexOf(";")) + "/" + className;
            className = className.replace(/\./g,"/");
        }
        console.log("className:" + className);
        $('#SourceCodeFileName').text(className);
    });
}

$('#execute').click(function () {
    $('#execute').attr("disabled", true);
    $('#loading').show();
    var form = new FormData();
    form.append("className", $('#SourceCodeFileName').text());
    form.append("sourceCode", editor.getValue());

    var settings = {
        "url": "/remote/executeJavaSourceCode",
        "method": "POST",
        "timeout": 0,
        "processData": false,
        "mimeType": "multipart/form-data",
        "contentType": false,
        "data": form
    };
    $.ajax(settings).done(function (response) {
        $("textarea[name='executeResult']").val(response);
        $('#execute').attr("disabled", false);
        $('#loading').hide();
    });
});
</script>
</body>
</html>