<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <!-- 必须的 meta 标签 -->
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="/bootstrap-5.1.3/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="/jstree3.3.12/themes/default/style.min.css"/>
    <link rel="stylesheet" href="/codemirror-5.64.0/lib/codemirror.css"/>

    <script src="/jquery-3.6.0/jquery-3.6.0.min.js"></script>
    <script src="/bootstrap-5.1.3/js/bootstrap.bundle.min.js"></script>
    <script src="/jstree3.3.12/jstree.min.js"></script>
    <script src="/codemirror-5.64.0/lib/codemirror.js"></script>
    <script src="/codemirror-5.64.0/mode/clike/clike.js"></script>  <!--Java代码高亮-->

    <title>Web IDE</title>
</head>

<body class="container-fluid">
<div class="row border">
    <div class="col">
        <ul class="nav nav-pills">
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle text-dark" data-toggle="dropdown" href="#" role="button"
                   aria-expanded="false">File</a>
                <div class="dropdown-menu">
                    <a class="dropdown-item" href="#">Create File</a>
                    <a class="dropdown-item" href="#">Delete File</a>
                    <a class="dropdown-item" href="#">Rename File</a>
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item" href="#">Create folder</a>
                </div>
            </li>
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle text-dark" data-toggle="dropdown" href="#" role="button"
                   aria-expanded="false">Git</a>
                <div class="dropdown-menu">
                    <a class="dropdown-item" href="#">Commit</a>
                    <a class="dropdown-item" href="#">Pull</a>
                    <a class="dropdown-item" href="#">Push</a>
                </div>
            </li>
            <li class="nav-item">
                <a id="execute" class="nav-link text-dark" role="button">
                    Run
                    <span id="loading" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"
                          style="display: none"></span></a>
            </li>
        </ul>
    </div>
</div>
<div class="row">
    <div class="col-2 border" style="padding-right:0px;padding-left:0px;">
        <div id="jstree"></div>
    </div>
    <div class="col-10 border" style="padding-right:0px;padding-left:0px;">
        <div class="editor_control">
            <textarea class="form-control" id="code" name="code" style="display: none;" rows="30">
/**
 * 简单示例
 *
 * @author jiazhifeng
 * @date 2021/12/07 10:14
 */
public class HelloWorld {
    public static void main(String[] args) {
        System.out.println("HelloWorld");
    }
}
            </textarea>
        </div>
    </div>
</div>
<div class="row border">
    <div class="col" style="padding-right:0px;padding-left:0px;">
        <div class="form-group">
            <textarea name="executeResult" class="form-control" id="exampleFormControlTextarea1" rows="10"
                      placeholder="控制台" readonly></textarea>
        </div>
    </div>
</div>

<div id="SourceCodeFileName" hidden>HelloWorld.java</div>

<script>
$(function () {
    var settings = {
            "url": "/project/tree",
            "method": "GET",
            "timeout": 0,
            "processData": false,
            "mimeType": "multipart/form-data",
            "dataType": "json",
            "contentType": false,
            "data": null
    };
    $.ajax(settings).done(function (response) {
        console.log(response);
        $('#jstree').jstree({
            "plugins" : [ "wholerow" ],
            "core" : {
                'data' : response
            }
        });
    });

    $('#jstree').on("changed.jstree", function (e, data) {
        console.log(data);
        getFileByPath(data.selected);
    });
});

var editor = CodeMirror.fromTextArea(document.getElementById("code"), {
    mode: "text/x-java",
    lineNumbers: true,
    matchBrackets: true,
    indentUnit: 4,
    indentWithTabs: true,
});
editor.setSize('auto', '620');

function getFileByPath(filePath) {
    console.log(filePath);
    if( /^.*\.java$/.test(filePath)){
        console.log("正在从服务器获取文件内容");
        var form = new FormData();
        form.append("filePath", filePath);
        var settings = {
            "url": "/project/getFile",
            "method": "POST",
            "timeout": 0,
            "processData": false,
            "mimeType": "multipart/form-data",
            "contentType": false,
            "data": form
        };
        $.ajax(settings).done(function (response) {
            $('#SourceCodeFileName').text(filePath);
            editor.setValue(response);
        });
    }
}

$('#execute').click(function () {
    $('#execute').attr("disabled", true);
    $('#loading').show();
    var form = new FormData();
    form.append("className", $('#SourceCodeFileName').text());
    form.append("sourceCode", editor.getValue());

    var settings = {
        "url": "/remote/executeJavaSourceCode",
        "method": "POST",
        "timeout": 0,
        "processData": false,
        "mimeType": "multipart/form-data",
        "contentType": false,
        "data": form
    };
    $.ajax(settings).done(function (response) {
        $("textarea[name='executeResult']").val(response);
        $('#execute').attr("disabled", false);
        $('#loading').hide();
    });
});
</script>
</body>
</html>